# Coding Rules — コーディング規約統合版

> 本ファイルはリーダブルコードの原則およびチーム内運用ルールを統合した規約です。

---

## 1. 基本理念（Readable Code 第 1 章）

コードは「人が読むために書く」もの。  
最優先は **理解の速さと正確さ** であり、短さやトリックよりも読みやすさを重視する。

### 指針

- 6 か月後の自分が読んで理解できるかを基準にする
- コメントよりも、まずコード自体を明確にする
- 設計・パフォーマンスと可読性を両立する意識を持つ

---

## 2. 名前付け（第 2・3 章）

### 原則

- 名前にはできるだけ多くの意味を込める
- 誤解を生む可能性のある命名を避ける
- 短さよりも明確さを優先する

### 実践ルール

- `get()` より `fetchAllUsersFromDB()` のように具体化
- ブール値は肯定形で：`isVisible`, `hasPermission`
- 単位・スケールを含める：`delaySec`, `sizeMB`
- 一時変数（`tmp`, `val`, `data`など）を避ける
- 範囲・境界を表す場合は含意が明確な名前にする  
  （例：`firstIndex` / `lastIndex` / `minValue` / `maxValue`）

---

## 3. コメント（第 5・6 章）

### 原則

- コメントは「なぜ・どんな背景で」書かれたかを説明する
- コードの動作説明だけのコメントは不要

### 書くべきコメント

- トレードオフや設計意図
- マジックナンバーの理由
- 例外・制約・暫定的対応（HACK, FIXME）

### 書かないコメント

- コードをなぞるだけの説明
- 放置された TODO（期限のないもの）

### キーワード運用

| キー    | 意味             |
| ------- | ---------------- |
| `TODO`  | 将来対応予定     |
| `FIXME` | 既知の不具合     |
| `HACK`  | 暫定的な回避策   |
| `XXX`   | 危険・注意点あり |

---

## 4. コード構造と美しさ（第 4・7・8 章）

### 原則

- 一貫したスタイルはチーム全体の理解を早める
- インデント・改行・空行は論理的段落を表す

### 実践ルール

- 論理段落（入力 → 検証 → 出力）ごとに空行で区切る
- 肯定条件を先に、否定条件はガード節で早期 return
- ネストは浅く、早期リターンで分岐を減らす
- `do...while` より `while` / `for` を優先
- 類似処理の構造（変数順・if 構成）は揃える

---

## 5. 式と変数（第 8・9 章）

### 原則

- 複雑な式は分解し、説明変数を導入する
- スコープを狭く、再代入を減らす

### 実践ルール

- 長い条件式は説明変数に分解
  ```ts
  const isUserOwner = user.id === doc.ownerId;
  if (isUserOwner) { ... }
  ```
- 宣言と利用を近くに配置する
- 中間変数が一度しか使われないなら削除する
- 意味が変わる場合は新しい変数名を使う（再利用しない）

## 6. 自動生成物・設定ファイル

### 原則

- 自動生成ファイル（例：`orval`, `biome`, `openapi`, `graphql`）は手動編集しない
- 更新手順を明記し、変更時は PR テンプレートに記録する

### 実践ルール

- `bun orval` や `biome.json` の更新漏れを防ぐため、PR チェックリストに項目を追加する
- 差分が発生した場合は regenerate してコミットする
- 自動生成スクリプトを実行する場合は、対応するコマンド (`make generate`, `bun orval` など) を README に明記する

---

## 7. テストコード（Testing Library / MSW）

### 原則

- テストコードもプロダクションコードと同様に「リーダブル」であること
- テストは **仕様の説明** として機能すること

### 実践ルール

- `it`／`test` 名は仕様を説明する自然文にする
  - ❌ `it('works')`
  - ✅ `it('displays user name after login')`
- Testing Library の推奨パターンを守る（`screen`, `waitFor`, `findBy*`）
- 状態を直接操作せず、ユーザー操作を再現する
- MSW のハンドラは `__mocks__/handlers` など統一ディレクトリで管理する
- 不安定なテスト（Flaky Test）は `p0_flaky` 等の明示的なディレクトリに分離する

---

## 8. コンポーネント / UI 一貫性

### 原則

- 共通 UI コンポーネント（例：`~/components/shadcn-ui/*`）を優先利用する
- 再実装よりも既存コンポーネントの拡張・再利用を検討する

### 実践ルール

- `Typography`, `Separator` など共有 UI を再定義しない
- Props の命名・責務を揃える（例：`isOpen`, `onClose`）
- DOM 構造・アクセシビリティ属性（`aria-*`）は各プロジェクトの基準に準拠する

---

## 9. ログ・デバッグコード

### 原則

- 本番コードに不要なログや環境変数、デバッグコードを残さない

### 実践ルール

- `console.log` の直接使用は禁止。`logger` 経由を徹底する
- 一時的なデバッグコードは PR 時に削除確認を行う
- デバッグや実験目的のコードにはコメントで意図を残す（例：`// temporary check for analytics`）

---

## 10. 運用とレビュー

### 原則

- 本ルールは「改善可能な生きたドキュメント」として運用する
- チーム全体で一貫性を保ちながら継続的にアップデートする

### 実践ルール

- 新しいルールを追加する場合は PR 提案＋ Slack 共有を行う
- 更新履歴は `meta/update_policy.md` に追記する
- 新メンバーは初回レビュー前に `rules.md` を必ず確認する

---

## 参考文献

- 『リーダブルコード ― より良いコードを書くためのシンプルで実践的なテクニック』  
  Dustin Boswell, Trevor Foucher 著（O'Reilly Japan, ISBN 978-4873115658）
- [The Art of Readable Code (English Original)](https://www.amazon.com/dp/0596802293)
- [Google Style Guide](https://google.github.io/styleguide/)
- [Clean Code — Robert C. Martin](https://www.oreilly.com/library/view/clean-code/9780136083238/)
