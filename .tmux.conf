# ---- General ----
set -g default-shell /bin/zsh
set -g default-command "/bin/zsh -l"
set -g default-terminal "tmux-256color"
set -as terminal-overrides ",*:Tc"
set -g base-index 1
set -g renumber-windows on
set -g mouse on
set -sg escape-time 0
set -g set-clipboard on
setw -g automatic-rename off
setw -g mode-keys vi

# ---- Status Bar ----
set -g status-interval 5
set -g status-bg black
set -g status-fg white
set -g status-left-length 60
set -g status-right-length 90
set -g status-left "#(~/.tmux/tmux-powerline/powerline.sh left)"
set -g status-right "#(~/.tmux/tmux-powerline/powerline.sh right)"

# ---- Key Bindings ----
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# ペインリサイズ
bind -r C-h resize-pane -L 5
bind -r C-j resize-pane -D 5
bind -r C-k resize-pane -U 5
bind -r C-l resize-pane -R 5

# ペイン間の素早い移動（prefix 不要）
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# 新ウィンドウ/ペインはカレントディレクトリを引き継ぐ
bind c new-window -c "#{pane_current_path}"
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# ---- Mouse ----
# マウススクロールで copy-mode へ
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind -n WheelDownPane select-pane -t= \; send-keys -M

# クリック/ドラッグで自動的に copy-mode へ
bind -n MouseDown1Pane if-shell -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e; send-keys -M'
bind -n MouseDrag1Pane if-shell -Ft= '#{pane_in_mode}' 'send-keys -M' 'send-keys -M'

# ---- Copy Mode (Mac クリップボード連携) ----
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# ---- AI Tools ----
# fzf でファイル選択 → クリップボードにパスをコピー
bind f display-popup -w 80% -h 60% -E \
  'find . -type f -not -path "*/.git/*" -not -path "*/node_modules/*" | fzf --preview "head -50 {}" | tr -d "\n" | pbcopy && echo "Copied!"'

# fzf でセッション切替（大文字 S: デフォルトの choose-tree との競合回避）
bind S display-popup -w 60% -h 40% -E \
  'tmux list-sessions -F "#{session_name}" | fzf | xargs tmux switch-client -t'

# 現在のペイン内容をクリップボードにキャプチャ（直近100行）
bind Y run-shell "tmux capture-pane -p -S -100 | pbcopy" \; display "Pane captured!"

# ---- Plugins (TPM) ----
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# TPM 初期化（この行は必ず末尾に配置）
run '~/.tmux/plugins/tpm/tpm'
